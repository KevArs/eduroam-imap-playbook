# -*- text -*-
######################################################################
#
#  This is a virtual server that handles incoming EAP for eduroam
#  It is mostly configured per
#  https://wiki.geant.org/display/H2eduroam/freeradius-sp and
#  https://wiki.geant.org/display/H2eduroam/freeradius-idp
#
######################################################################

server eduroam {
	authorize {
		# only use filter_username from version > 3.0.7 or > 2.2.8 on
		filter_username
		rewrite.called_station_id
		rewrite.calling_station_id
		if ( 
			{%- for flr in eduroam_flr_servers -%}
				"%{client:shortname}" != "{{ (flr.hostname|default('unknown')).split('.')|first }}"
				{%- if not loop.last %} && {% endif -%}
			{%- endfor -%}
		) {
			update request {
				Operator-Name := "1{{radius_realm|default("example.ac.za")}}"
				# the literal number "1" above is an important prefix! Do not change it!
			}
		}
		# if you want detailed logging
		auth_log
		eap {
			ok = return
		}
	}

	authenticate {
		eap
	}

	preacct {
		suffix
	}

	accounting {
	}

	post-auth {
		# if you want detailed logging
		reply_log
		f_ticks
		Post-Auth-Type REJECT {
			reply_log
			f_ticks
			eap
			attr_filter.access_reject
		}
	}

	pre-proxy {
		# if you want detailed logging
		pre_proxy_log
		if("%{Packet-Type}" != "Accounting-Request") {
			attr_filter.pre-proxy
		}
	}

	post-proxy {
		# if you want detailed logging
		post_proxy_log
		attr_filter.post-proxy
		eap
	}
}
