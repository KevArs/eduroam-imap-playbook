# -*- text -*-
######################################################################
#
#  This is a virtual server that handles incoming EAP for eduroam
#  It is mostly configured per
#  https://wiki.geant.org/display/H2eduroam/freeradius-sp and
#  https://wiki.geant.org/display/H2eduroam/freeradius-idp
#
#  authorize → authenticate → pre-proxy → [PROXY] → post-proxy → post-auth
#
######################################################################

server eduroam {
        # Configure this virtual server to listen on all available
        # IPv4 and IPv6 addresses on the default ports for auth+acct
        #
        # This duplicates what's in sites-available/default, which is
        # enabled by default and thus is commented out here. You can
        # EITHER rely on the default virtual server to bind your ports,
        # OR you can disable it by deleting the symlink from
        # sites-enabled/default and then uncomment listen here.

    
        authorize {
                # only use filter_username from version > 3.0.7
                filter_username
                # these normalise MAC addresses
                rewrite_called_station_id
                rewrite_calling_station_id
                if (
                      {%- for flr in eduroam_flr_servers -%}
                           "%{client:shortname}" != "{{ (flr.hostname|default('unknown')).split('.')|first }}"
                           {%- if not loop.last %} && {% endif -%}
                      {%- endfor -%}
                ) {
                        update request {
                             {% for r in radius_realm %}
                             &Operator-Name := "1{{r.realm_name|default("example.ac.za")}}"
                             # the literal number "1" above is an important prefix! Do not change it!
                             &Eduroam-SP-Country := "{{r.realm_name.split('.')|last|upper|default("UNKNOWN")}}"
                             {% endfor %}
                        }
                }
                cui
                # if you want detailed logging
                auth_log
                suffix
                switch &Realm {
                {% for r1 in radius_realm %}
                     case {{r1.realm_name}} {
                           {{r1.eap_module_name}}
                     }
                {% endfor %}
                }
        }
        
        authenticate {
            {% for eap_module in radius_realm %}
                {{eap_module.eap_module_name}}
            {% endfor %}
        }

        preacct {
                rewrite_called_station_id
                rewrite_calling_station_id
                suffix
        }

        accounting {
        }

        post-auth {
                update {
                        &reply: += &session-state:
                }
                # if you want detailed logging
                reply_log
                f_ticks
                linelog_elk
                remove_reply_message_if_eap
                Post-Auth-Type REJECT {
                        reply_log
                        f_ticks
                        attr_filter.access_reject
                        linelog_elk
                    {% for eap_modules in radius_realm %}
                    {{eap_modules.eap_module_name}}
                    {% endfor %}
                        remove_reply_message_if_eap
                }
        }

        pre-proxy {
                cui
                # if you want detailed logging
                pre_proxy_log
                if("%{Packet-Type}" != "Accounting-Request") {
                        attr_filter.pre-proxy
                }
        }

        post-proxy {
                # if you want detailed logging
                post_proxy_log
                attr_filter.post-proxy
                {% for eap_module1 in radius_realm %}
                {{eap_module1.eap_module_name}}
                {% endfor %}
        }
}

